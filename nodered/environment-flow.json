[{"id":"f6f2187d.f17ca8","type":"tab","label":"Environment","disabled":false,"info":""},{"id":"e8dd6170.0ff208","type":"mqtt in","z":"f6f2187d.f17ca8","name":"","topic":"+/+/bedroom/+/environment","qos":"2","datatype":"auto","broker":"af2ecbdd.767f08","x":160,"y":280,"wires":[["ebfb4603.f4073","c9c3c355.bbea","d259d1d7.f710a8"]]},{"id":"ebfb4603.f4073","type":"function","z":"f6f2187d.f17ca8","name":"retrieveData","func":"var dataObject = {};\nvar msgParts = msg.topic.split(\"/\")\ndataObject[\"idTenant\"] = msgParts[0];\ndataObject[\"idResidence\"] = msgParts[1];\ndataObject[\"idBedroom\"] = msgParts[3];\nmsg.payload = dataObject\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","x":470,"y":380,"wires":[["e7491554.b9831"]]},{"id":"c9c3c355.bbea","type":"decode","z":"f6f2187d.f17ca8","name":"DecodeEnvironment","protofile":"60305973.f62a9","protoType":"environmentMessage","x":480,"y":160,"wires":[["e7491554.b9831"]]},{"id":"e7491554.b9831","type":"join","z":"f6f2187d.f17ca8","name":"datamerged","mode":"custom","build":"merged","property":"payload","propertyType":"msg","key":"","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"0","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":710,"y":280,"wires":[["5868a5a0.b8c68c","b19115ae.a9c7a8"]]},{"id":"21a9635b.75d3ec","type":"http request","z":"f6f2187d.f17ca8","name":"POST to influx","method":"POST","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1880,"y":280,"wires":[["afb70dbf.f716c8","17be8302.ab4f4d"]]},{"id":"cb7201bb.0ea3e","type":"function","z":"f6f2187d.f17ca8","name":"Prepare POST Presence","func":"var influxPostLine = ',presence=#presence';\ninfluxPostLine = influxPostLine.replace('#presence',msg.payload.presence);\nmsg.payload = 'presence ' + msg.influxLine + influxPostLine;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":160,"wires":[["88288154.2926a8"]]},{"id":"559ae3eb.fddb4c","type":"switch","z":"f6f2187d.f17ca8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"hask","v":"presence","vt":"str"},{"t":"hask","v":"airQuality","vt":"str"},{"t":"hask","v":"humidity","vt":"str"},{"t":"hask","v":"temperature","vt":"str"},{"t":"hask","v":"lightLevel","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":1050,"y":280,"wires":[["cb7201bb.0ea3e"],["4a8ca452.21d834"],["f1fe4d01.2750e"],["61310029.0056"],["ed004645.5e43c"]]},{"id":"4a8ca452.21d834","type":"function","z":"f6f2187d.f17ca8","name":"Prepare POST Air Quality","func":"var influxPostLine = ',airQuality=#airQuality';\ninfluxPostLine = influxPostLine.replace('#airQuality',msg.payload.airQuality);\nmsg.payload = 'airQuality ' + msg.influxLine + influxPostLine;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":220,"wires":[["88288154.2926a8"]]},{"id":"f1fe4d01.2750e","type":"function","z":"f6f2187d.f17ca8","name":"Prepare POST Humidity","func":"var influxPostLine = ',humidity=#humidity';\ninfluxPostLine = influxPostLine.replace('#humidity',msg.payload.humidity);\nmsg.payload = 'humidity ' + msg.influxLine + influxPostLine;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":280,"wires":[["88288154.2926a8"]]},{"id":"61310029.0056","type":"function","z":"f6f2187d.f17ca8","name":"Prepare POST Temperature","func":"var influxPostLine = ',temperature=#temperature';\ninfluxPostLine = influxPostLine.replace('#temperature',msg.payload.temperature);\nmsg.payload = 'temperature ' + msg.influxLine + influxPostLine;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1320,"y":340,"wires":[["88288154.2926a8"]]},{"id":"ed004645.5e43c","type":"function","z":"f6f2187d.f17ca8","name":"Prepare POST LightLevel","func":"var influxPostLine = ',lightLevel=#lightLevel';\ninfluxPostLine = influxPostLine.replace('#lightLevel',msg.payload.lightLevel);\nmsg.payload = 'light ' + msg.influxLine + influxPostLine;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1310,"y":400,"wires":[["88288154.2926a8"]]},{"id":"5868a5a0.b8c68c","type":"debug","z":"f6f2187d.f17ca8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":890,"y":140,"wires":[]},{"id":"25324058.6b9cf8","type":"link out","z":"f6f2187d.f17ca8","name":"","links":["2f09ab16.783014"],"x":2375,"y":280,"wires":[]},{"id":"11d8d377.cbf49d","type":"debug","z":"f6f2187d.f17ca8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1870,"y":400,"wires":[]},{"id":"88288154.2926a8","type":"function","z":"f6f2187d.f17ca8","name":"Prepare POST URL","func":"var postUrl = \"http://#influxIp:8086/write?db=#db\";\npostUrl =  postUrl.replace('#influxIp', env.get(\"INFLUX_IP\"));\npostUrl =  postUrl.replace('#db', env.get(\"SENSOR_DATABASE_NAME\"));\nmsg.url = postUrl;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1640,"y":280,"wires":[["21a9635b.75d3ec","11d8d377.cbf49d"]]},{"id":"afb70dbf.f716c8","type":"debug","z":"f6f2187d.f17ca8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"statusCode","targetType":"msg","statusVal":"","statusType":"auto","x":2080,"y":360,"wires":[]},{"id":"b19115ae.a9c7a8","type":"function","z":"f6f2187d.f17ca8","name":"DataToMsg","func":"msg.idResidence = msg.payload.idResidence;\nmsg.idTenant = msg.payload.idTenant;\nmsg.idBedroom = msg.payload.idBedroom;\nmsg.influxLine = \"idTenant=#idTenant,idResidence=#idResidence,idBedroom=#idBedroom\"\nmsg.influxLine = msg.influxLine.replace('#idTenant',msg.payload.idTenant);\nmsg.influxLine = msg.influxLine.replace('#idResidence',msg.payload.idResidence);\nmsg.influxLine = msg.influxLine.replace('#idBedroom',msg.payload.idBedroom);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":890,"y":280,"wires":[["559ae3eb.fddb4c"]]},{"id":"d259d1d7.f710a8","type":"debug","z":"f6f2187d.f17ca8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","statusVal":"","statusType":"auto","x":340,"y":500,"wires":[]},{"id":"17be8302.ab4f4d","type":"switch","z":"f6f2187d.f17ca8","name":"Check statusCode","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"400","vt":"str"},{"t":"neq","v":"400","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":2130,"y":280,"wires":[["6c485acf.0a4d7c"],["25324058.6b9cf8"]]},{"id":"6c485acf.0a4d7c","type":"debug","z":"f6f2187d.f17ca8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2350,"y":180,"wires":[]},{"id":"af2ecbdd.767f08","type":"mqtt-broker","name":"mqtt-server","broker":"broker","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"60305973.f62a9","type":"protobuf-file","protopath":"/usr/src/node-red/environment.proto","watchFile":true}]